
{% extends "base.html" %} {# Inherit from base.html #}

{% block title %}Shopping Cart{% endblock %} {# Set the page title #}

{% block content %} {# Start the content block #}

    <h1 class="text-center mb-4">Your Shopping Cart</h1>

    <div id="cart-container">
        {# Cart items will be rendered here by JavaScript #}
    </div>

    <div id="cart-summary" class="row justify-content-end" style="display: none;"> {# Initially hidden #}
         <div class="col-md-4">
            <div class="card rounded">
                <div class="card-header">
                    Order Summary
                </div>
                <ul class="list-group list-group-flush">
                    <li class="list-group-item d-flex justify-content-between rounded-top">
                        <span>Subtotal</span>
                        <strong id="cart-subtotal">$0.00</strong>
                    </li>
                    <li class="list-group-item d-flex justify-content-between">
                        <span>Tax (<span id="tax-rate">{{ (tax_rate * 100) | round(2) }}</span>%)</span> {# Display tax rate #}
                        <span id="cart-tax">$0.00</span>
                    </li>
                     <li class="list-group-item d-flex justify-content-between">
                        <span>Shipping & Handling</span>
                        <span id="shipping-cost">${{ "%.2f" | format(shipping_cost) }}</span> {# Display shipping cost #}
                    </li>
                    <li class="list-group-item d-flex justify-content-between rounded-bottom">
                        <span><strong>Total (USD)</strong></span>
                        <strong id="cart-total">$0.00</strong>
                    </li>
                </ul>
            </div>

            <hr class="my-4"> {# Horizontal rule #}

            {% if 'user_id' in session %}
                {# If user is logged in, show checkout button #}
                <a href="{{ url_for('checkout') }}" class="btn btn-primary btn-lg w-100 rounded">Proceed to Checkout</a> {# TODO: Implement checkout route #}
            {% else %}
                {# If user is not logged in, show signup/login buttons #}
                <p class="text-center mb-2">Ready to checkout?</p>
                <a href="{{ url_for('signup') }}" class="btn btn-success w-100 mb-2 rounded">Sign Up</a>
                <a href="{{ url_for('login') }}" class="btn btn-secondary w-100 rounded">Login</a>
            {% endif %}
        </div>
    </div>

    <div id="empty-cart-message" class="alert alert-info text-center rounded" role="alert" style="display: none;"> {# Initially hidden #}
        Your cart is empty.
    </div>
    <div id="continue-shopping-button" class="text-center" style="display: none;"> {# Initially hidden #}
        <a href="{{ url_for('index') }}" class="btn btn-primary rounded">Continue Shopping</a>
    </div>

{% endblock %} {# End the content block #}

{% block scripts_extra %} {# Add extra scripts here #}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        const cartContainer = document.getElementById('cart-container');
        const cartSummary = document.getElementById('cart-summary');
        const emptyCartMessage = document.getElementById('empty-cart-message');
        const continueShoppingButton = document.getElementById('continue-shopping-button');

        const cartSubtotalElement = document.getElementById('cart-subtotal');
        const cartTaxElement = document.getElementById('cart-tax');
        const cartTotalElement = document.getElementById('cart-total');
        const shippingCostElement = document.getElementById('shipping-cost');
         const taxRateElement = document.getElementById('tax-rate');

        // Function to render cart items from local storage
        function renderCart() {
            let cart = JSON.parse(localStorage.getItem('cart')) || {};
            cartContainer.innerHTML = ''; // Clear current cart display

            if (Object.keys(cart).length === 0) {
                // Cart is empty
                emptyCartMessage.style.display = 'block';
                continueShoppingButton.style.display = 'block';
                cartSummary.style.display = 'none';
            } else {
                // Cart has items
                emptyCartMessage.style.display = 'none';
                continueShoppingButton.style.display = 'none';
                cartSummary.style.display = 'flex'; // Use flex for the row layout

                let subtotal = 0;
                const itemsList = document.createElement('ul');
                itemsList.classList.add('list-group', 'mb-3');

                for (const productId in cart) {
                    const item = cart[productId];
                    const itemTotal = item.price * item.quantity;
                    subtotal += itemTotal;

                    const listItem = document.createElement('li');
                    listItem.classList.add('list-group-item', 'd-flex', 'justify-content-between', 'lh-sm', 'rounded');
                    listItem.innerHTML = `
                        <div class="d-flex align-items-center">
                            <img src="${item.image}" alt="${item.name}" class="img-thumbnail me-3 rounded" style="width: 80px; height: 80px; object-fit: cover;">
                            <div>
                                <h6 class="my-0">${item.name}</h6>
                                <small class="text-muted">Quantity: ${item.quantity}</small>
                                <p class="text-muted mb-0">$${item.price.toFixed(2)} each</p>
                            </div>
                        </div>
                        <span class="text-muted">$${itemTotal.toFixed(2)}</span>
                        <button type="button" class="btn btn-danger btn-sm ms-3 rounded remove-item-btn" data-product-id="${productId}">Remove</button>
                    `;
                    itemsList.appendChild(listItem);
                }

                 cartContainer.appendChild(itemsList);

                // Add event listeners to the newly created remove buttons
                addRemoveButtonListeners();

                // Calculate and display totals
                const taxRate = parseFloat(taxRateElement.textContent) / 100; // Get tax rate from template
                const shippingCost = parseFloat(shippingCostElement.textContent.replace('$', '')); // Get shipping cost
                const tax = subtotal * taxRate;
                const total = subtotal + tax + shippingCost;

                cartSubtotalElement.textContent = `$${subtotal.toFixed(2)}`;
                cartTaxElement.textContent = `$${tax.toFixed(2)}`;
                cartTotalElement.textContent = `$${total.toFixed(2)}`;

                 // Update cart count display in the navbar
                 updateCartCountDisplay();
            }
        }

        // Function to add event listeners to remove buttons
        function addRemoveButtonListeners() {
            const removeButtons = document.querySelectorAll('.remove-item-btn');
            removeButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const productId = this.dataset.productId;
                    removeItemFromCart(productId);
                });
            });
        }

        // Function to remove an item from local storage cart
        function removeItemFromCart(productId) {
            let cart = JSON.parse(localStorage.getItem('cart')) || {};
            if (cart[productId]) {
                delete cart[productId]; // Remove the item
                localStorage.setItem('cart', JSON.stringify(cart)); // Save updated cart
                renderCart(); // Re-render the cart display
                alert('Item removed from cart.'); // Provide feedback
            }
        }

         // Function to update a cart count element (you'll need an element with id="cart-count" in base.html)
        function updateCartCountDisplay() {
            let cart = JSON.parse(localStorage.getItem('cart')) || {};
            let totalItems = 0;
            for (const productId in cart) {
                totalItems += cart[productId].quantity;
            }
            const cartCountElement = document.getElementById('cart-count');
            if (cartCountElement) {
                cartCountElement.textContent = totalItems;
            }
        }

        // Initial render of the cart when the page loads
        renderCart();
    });
</script>
{% endblock %}
